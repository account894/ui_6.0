<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ğŸŒ AI ë§¤ì¹­ ì‹œìŠ¤í…œ( UI6.0 beta )</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- ìŠ¤íƒ€ì¼ ì§€ì›ì„ ìœ„í•œ ExcelJS ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .btn-text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">ê²¬ì ë„ìš°ë¯¸ v6.0 (ë¬´ë£Œë²„ì ¼) </h1>
            <p class="text-slate-600 font-medium text-indigo-600">S A M J I N </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 1. ì„¤ì • ë° ì—…ë¡œë“œ -->
            <div class="md:col-span-1 space-y-6">

                <!-- ì‹œíŠ¸ ì„ íƒ (10ê°œë¡œ í™•ì¥ë¨) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">DB ì‹œíŠ¸ ì„ íƒ</h2>
                    <select id="sheetSelect" class="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="BIGDATA">BIGDATA</option>
                        <option value="ì„¸í•œ,ì§„ì•ˆ,ë‘ë¦¬,ì„ ì§„ê¸ˆì† ì™¸5">ì„¸í•œ,ì§„ì•ˆ,ë‘ë¦¬,ì„ ì§„ê¸ˆì† ì™¸5</option>
                        <option value="ckwë‹¨ê°€(ì—…ëƒì˜ˆì •)">ckwë‹¨ê°€(ì—…ëƒì˜ˆì •)</option>
                        <option value="Sheet4">Sheet4</option>
                        <option value="Sheet5">Sheet5</option>
                        <option value="Sheet6">Sheet6</option>
                        <option value="Sheet7">Sheet7</option>
                        <option value="Sheet8">Sheet8</option>
                        <option value="Sheet9">Sheet9</option>
                        <option value="Sheet10">Sheet10</option>
                    </select>
                    <div id="dbStatus" class="mt-2 text-sm text-amber-600">DB ìƒíƒœ: ë¡œë“œ ì „</div>
                </div>

                <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">íŒŒì¼ ì—…ë¡œë“œ</h2>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all cursor-pointer border border-slate-200 rounded-lg p-1">
                </div>

                <!-- ì‹¤í–‰ ë²„íŠ¼ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">ì‹¤í–‰ ë° ì €ì¥</h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="startWorkerMatch()" id="matchBtn" disabled
                            class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 disabled:bg-slate-300 disabled:shadow-none transition-all relative overflow-hidden btn-text-shadow border border-indigo-600">
                            âš¡ë§¤ì¹­ ì‹¤í–‰
                        </button>
                        <button onclick="downloadExcel()" id="downloadBtn" disabled
                            class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 disabled:opacity-50 transition-all">
                            ì—‘ì…€ ê²°ê³¼ ì €ì¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. ë¡œê·¸ -->
            <div class="md:col-span-2 space-y-4">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-xl flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-slate-200 font-semibold">ì‹œìŠ¤í…œ ë¡œê·¸</h2>
                        <button onclick="clearLog()" class="text-xs text-slate-400 hover:text-white uppercase tracking-wider">Clear</button>
                    </div>
                    <div id="log" class="log-container flex-1 text-[13px] font-mono text-green-400 overflow-y-auto whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl border border-slate-100">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-slate-800">ì•Œë¦¼</h3>
            <p id="modalMsg" class="text-slate-600 mb-6 leading-relaxed"></p>
            <button onclick="closeModal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition-colors">í™•ì¸</button>
        </div>
    </div>

    <!-- Worker Script -->
    <script id="worker-script" type="javascript/worker">
        const SYNONYM_MAP = {
            "ë‹¥íŠ¸": "ë•íŠ¸", "DUCT": "ë•íŠ¸", "ë°°ê´€": "ê´€", "íŒŒì´í”„": "ê´€", "PIPE": "ê´€","ë³´ì˜¨ì¬": "ë³´ì˜¨", "ê´€ë³´ì˜¨": "ë³´ì˜¨",
            "ë°œí¬í´ë¦¬ì—í‹¸ë Œ": "ë°œí¬", "ê³ ë¬´ë°œí¬": "ë°œí¬", "ê°€êµë°œí¬": "ë°œí¬", "ë‚œì—°": "ì•„í‹°ë¡ ",
            "ì€ë°•": "ë§¤ì§í…Œì´í”„", "ë§¤ì§": "ë§¤ì§í…Œì´í”„","í–‰ê±°": "í–‰ê°€", "ë‹¬ëŒ€": "ì „ì‚°", "í…Œí”„": "í…Œì´í”„","PUMP": "íŒí”„", "TANK": "íƒ±í¬", "GATE": "ê²Œì´íŠ¸", "S#": "SCH",
            "PIPE":"ê´€","íŒŒì´í”„":"ê´€","SPP":"ê°•ê´€","CARBON STEEL":"ê°•ê´€","í‘ê´€":"ê°•ê´€","ë°±ê´€":"ê°•ê´€",
            "SUS":"STS","STAINLESS":"STS","ìŠ¤í…":"STS","ìŠ¤í…Œì¸ë¦¬ìŠ¤":"STS","SU":"STS",
            "PVC":"PVC","VG1":"PVC","VG2":"PVC","COPPER":"ë™ê´€","ë™íŒŒì´í”„":"ë™ê´€",
            "PB":"PB","ì—ì´ì½˜":"PB","í´ë¦¬ë¶€í‹¸ë Œ":"PB","C-PVC":"CPVC","ì†Œë°©ìš©í•©ì„±ìˆ˜ì§€":"CPVC",
            "PE":"PE","P.E":"PE","HDPE":"PE","SR":"SR","S.R":"SR",
            "FITTING":"ì´ìŒì‡ ","ë¶€ì†":"ì´ìŒì‡ ","ELBOW":"ì—˜ë³´","ELL":"ì—˜ë³´",
            "TEE":"í‹°","í‹°ì´":"í‹°","REDUCER":"ë ˆë“€ìƒ¤","RED":"ë ˆë“€ìƒ¤","ì´ê²½ì†Œì¼“":"ë ˆë“€ìƒ¤",
            "SOCKET":"ì†Œì¼“","SOC":"ì†Œì¼“","COUPLING":"ì»¤í”Œë§",
            "ìº¡":"ìº¡","CAP":"ìº¡","ë§ˆê°œ":"ìº¡","FLANGE":"í”Œëœì§€",
            "UNION":"ìœ ë‹ˆì˜¨","UN":"ìœ ë‹ˆì˜¨","NIPPLE":"ë‹ˆí”Œ",
            "BUSHING":"ë¶€ì‹±","BUSH":"ë¶€ì‹±","ADAPTER":"ì•„ë‹µíƒ€","M.A":"ì•„ë‹µíƒ€","F.A":"ì•„ë‹µíƒ€","ADPT":"ì•„ë‹µíƒ€",
            "CROSS":"í¬ë¡œìŠ¤","SADDLE":"ìƒˆë“¤","PLUG":"í”ŒëŸ¬ê·¸","ë©”ê¾¸ë¼":"í”ŒëŸ¬ê·¸",
            "VALVE":"ë°¸ë¸Œ","V/V":"ë°¸ë¸Œ","V.V":"ë°¸ë¸Œ","GATE":"ê²Œì´íŠ¸","ì œìˆ˜ë³€":"ê²Œì´íŠ¸",
            "GLOBE":"ê¸€ë¡œë¸Œ","ìŠ¤í†±ë°¸ë¸Œ":"ê¸€ë¡œë¸Œ","CHECK":"ì²´í¬","íŒì²´í¬":"ì²´í¬","ìŠ¤ìœ™ì²´í¬":"ì²´í¬",
            "HAMMERLESS":"ì²´í¬","BALL":"ë³¼","ë³¼ë°¸ë¸Œ":"ë³¼","BUTTERFLY":"ë²„í„°í”Œë¼ì´","B.F":"ë²„í„°í”Œë¼ì´",
            "BFV":"ë²„í„°í”Œë¼ì´","STRAINER":"ìŠ¤íŠ¸ë ˆì´ë„ˆ","STR":"ìŠ¤íŠ¸ë ˆì´ë„ˆ","Y-STR":"ìŠ¤íŠ¸ë ˆì´ë„ˆ",
            "PRV":"ê°ì••ë³€","REDUCING":"ê°ì••ë³€","SOL":"ì†”ë ˆë…¸ì´ë“œ","SOLENOID":"ì†”ë ˆë…¸ì´ë“œ",
            "AIR VENT":"ì—ì–´ë²¤íŠ¸","A.V":"ì—ì–´ë²¤íŠ¸","í†µê¸°":"ì—ì–´ë²¤íŠ¸","SAFETY":"ì•ˆì „ë³€","RELIEF":"ë¦´ë¦¬í”„",
            "FLOAT":"ì •ìˆ˜ìœ„","F.V":"ì •ìˆ˜ìœ„","HEAD":"í—¤ë“œ","SPRINKLER":"í—¤ë“œ","S.P":"í—¤ë“œ",
            "ALARM":"ì•ŒëŒ","ìœ ìˆ˜ê²€ì§€":"ì•ŒëŒ","HYDRANT":"ì†Œí™”ì „","O.H":"ì†Œí™”ì „",
            "SIAMESE":"ì†¡ìˆ˜êµ¬","BOX":"ë°•ìŠ¤","í•©":"ë°•ìŠ¤","í•¨":"ë°•ìŠ¤","F.BOX":"ì†Œí™”ì „í•¨",
            "INSULATION":"ë³´ì˜¨","LAGGING":"ë³´ì˜¨","RUBBER":"ê³ ë¬´ë°œí¬","ì•„ë§ˆí”Œë ‰ìŠ¤":"ê³ ë¬´ë°œí¬",
            "GLASS WOOL":"ê·¸ë¼ìŠ¤ìš¸","ìœ ë¦¬ì†œ":"ê·¸ë¼ìŠ¤ìš¸","HANGER":"í–‰ê°€","CLEVIS":"í–‰ê°€","RING":"í–‰ê°€",
            "SUPPORT":"ì„œí¬íŠ¸","ì§€ì§€ëŒ€":"ì„œí¬íŠ¸","ANGLE":"ì•µê¸€","CHANNEL":"ì°¬ë„¬","ì”ë„¬":"ì°¬ë„¬",
            "BOLT":"ë³¼íŠ¸","NUT":"ë„ˆíŠ¸","GASKET":"ê°€ìŠ¤ì¼“","PACKING":"ê°€ìŠ¤ì¼“","P.K":"ê°€ìŠ¤ì¼“",
        };

        const MATERIAL_MAP = {
            "STS": ["STS","ìŠ¤í…","SUS","STAINLESS"],
            "STEEL": ["ê°•ê´€","SPP","ë°±ê´€","í‘ê´€","CARBON","SPPS"],
            "PVC": ["PVC","VG1","VG2"],
            "COPPER": ["ë™ê´€","ë™íŒŒì´í”„","COPPER"],
            "PB": ["PB","ì—ì´ì½˜"],
            "CPVC": ["CPVC"],
            "PE": ["PE","HDPE"]
        };

        const TYPE_MAP = {
            "ELBOW": ["ì—˜ë³´","ELL","L"],
            "TEE": ["í‹°","í‹°ì´","T"],
            "VALVE": ["ë°¸ë¸Œ","V/V"],
            "PIPE": ["íŒŒì´í”„","ê´€"]
        };

        const synKeys = Object.keys(SYNONYM_MAP).sort((a,b)=>b.length-a.length);
        const synRegex = new RegExp(synKeys.join("|"),"gi");

        function norm(v, isSpec = false){ 
            if(!v) return ""; 
            let str = v.toString().trim().toUpperCase(); 
            str = str.replace(synRegex,(m)=>SYNONYM_MAP[m.toUpperCase()]||m); 
            if (isSpec) {
                return str.replace(/[^A-Z0-9ê°€-í£./]/g,"");
            }
            return str.replace(/[^A-Z0-9ê°€-í£]/g,"").replace(/EA|EACH|ê°œ/g,"EA"); 
        }

        function getCategory(text, map) {
            for (const [key, keywords] of Object.entries(map)) {
                if (keywords.some(k => text.includes(k))) return key;
            }
            return null;
        }

        function isCategoryMismatch(src, tgt){ 
            const srcMat = getCategory(src, MATERIAL_MAP);
            const tgtMat = getCategory(tgt, MATERIAL_MAP);
            if (srcMat && tgtMat && srcMat !== tgtMat) return true;
            const srcType = getCategory(src, TYPE_MAP);
            const tgtType = getCategory(tgt, TYPE_MAP);
            if (srcType && tgtType && srcType !== tgtType) return true;
            return false; 
        }

        function calculateScore(srcText, tgtText) {
            if(!srcText || !tgtText) return 0;
            if(srcText === tgtText) return 100;
            if(tgtText.includes(srcText) || srcText.includes(tgtText)) return 85;
            let matchCount = 0;
            for(let i=0; i<srcText.length-1; i++) {
                const sub = srcText.substring(i, i+2);
                if(tgtText.includes(sub)) matchCount++;
            }
            return (matchCount / Math.max(srcText.length, tgtText.length)) * 100;
        }

        self.onmessage = function(e) {
            const { type, csvRows, dbRows } = e.data;
            if(type !== 'START') return;

            const finalResult = [];
            const total = csvRows.length;

            const processedDB = dbRows.map(row => ({
                original: row,
                normName: norm(row.A),
                normSpec: norm(row.B, true),
                normUnit: norm(row.C)
            }));

            for(let i=0; i < total; i++) {
                const percent = Math.floor((i / total) * 100);
                if(i % 100 === 0) self.postMessage({ type: 'PROGRESS', percent });

                const row = csvRows[i];
                const srcName = row[0] || "";
                const srcSpec = row[1] || "";
                const srcUnit = row[2] || "";
                const srcMat = row[3] || 0;
                const srcLab = row[4] || 0;

                const nName = norm(srcName);
                const nSpec = norm(srcSpec, true);
                const nUnit = norm(srcUnit);

                if(!nName) {
                    finalResult.push([srcName, srcSpec, srcUnit, srcMat, srcLab, "", ""]);
                    continue;
                }

                let candidates = [];
                for(let j=0; j < processedDB.length; j++) {
                    const dbItem = processedDB[j];
                    const isPerfectMatch = (nName === dbItem.normName && nSpec === dbItem.normSpec);
                    if(!isPerfectMatch && isCategoryMismatch(nName, dbItem.normName)) continue;
                    const nameScore = calculateScore(nName, dbItem.normName);
                    const specScore = calculateScore(nSpec, dbItem.normSpec);
                    const unitScore = (nUnit === dbItem.normUnit) ? 100 : 0;
                    let totalScore = (nameScore * 0.5) + (specScore * 0.4) + (unitScore * 0.1);
                    
                    if(isPerfectMatch) totalScore += 200; 
                    
                    if(totalScore > 15) { 
                        candidates.push({ score: totalScore, item: dbItem.original });
                    }
                }

                candidates.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    let valA = String(a.item.F || "");
                    let valB = String(b.item.F || "");
                    let numA = parseFloat(valA.replace(/[^0-9.-]/g, ''));
                    let numB = parseFloat(valB.replace(/[^0-9.-]/g, ''));
                    if (!isNaN(numA) && !isNaN(numB)) {
                        if (numB !== numA) return numB - numA; 
                    }
                    return valB.localeCompare(valA); 
                });

                const topCandidates = candidates.slice(0, 5); 

                finalResult.push([srcName, srcSpec, srcUnit, srcMat, srcLab, "", "ì›ë³¸"]);

                if (topCandidates.length === 0) {
                    finalResult.push(["", "", "", "", "", "ë§¤ì¹­ ë°ì´í„° ì—†ìŒ", "ë§¤ì¹­ì—†ìŒ"]);
                } else {
                    topCandidates.forEach((cand, idx) => {
                        const db = cand.item;
                        let status = `í›„ë³´ ${idx + 1}`;
                        if (idx === 0 && topCandidates.length > 1) {
                            const gap = topCandidates[0].score - topCandidates[1].score;
                            if (topCandidates[0].score < 200 && (gap < 10 || topCandidates[0].score < 50)) {
                                status += " (ì¶©ëŒ/ê²€í† í•„ìš”)";
                            }
                        }
                        finalResult.push([db.A || "", db.B || "", db.C || "", db.D || "", db.E || "", db.F || "", status]);
                    });
                }
                finalResult.push(["", "", "", "", "", "", ""]);
            }

            self.postMessage({ type: 'COMPLETE', resultRows: finalResult });
        };
    </script>

    <script>
        let dbRows = [];
        let csvRows = [];
        let worker = null;
        let resultRows = [];
        let uploadedFileName = "ë‹¨ê°€ë§¤ì¹­ê²°ê³¼"; 

        const logEl = document.getElementById("log");
        const matchBtn = document.getElementById("matchBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const dbStatus = document.getElementById("dbStatus");
        const sheetSelect = document.getElementById("sheetSelect");

        function initWorker() {
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            const workerUrl = URL.createObjectURL(blob);
            worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                const { type, percent, resultRows: res } = e.data;
                if(type === 'PROGRESS') {
                    matchBtn.style.background = `linear-gradient(to right, #059669 ${percent}%, #4f46e5 ${percent}%)`;
                    matchBtn.textContent = `âš¡ë¶„ì„ ì¤‘... ${percent}%`;
                } else if(type === 'COMPLETE') {
                    resultRows = res;
                    addLog(`ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ! (ì •ë°€ ì •ë ¬ ì•Œê³ ë¦¬ì¦˜ ì ìš©)`, 'success');
                    matchBtn.disabled = false;
                    matchBtn.style.background = '';
                    matchBtn.textContent = 'âš¡ë§¤ì¹­ ì‹¤í–‰';
                    downloadBtn.disabled = false;
                    showMessage("ë¶„ì„ ì™„ë£Œ", `ë°ì´í„° ë§¤ì¹­ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            };
        }

        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('ko-KR', {hour12:false});
            let prefix = "â—";
            if(type==='success') prefix="âœ“";
            if(type==='error') prefix="âœ—";
            const div = document.createElement('div');
            div.textContent = `[${time}] ${prefix} ${msg}`;
            if(type === 'error') div.style.color = '#ef4444';
            if(type === 'success') div.style.color = '#34d399';
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() { logEl.innerHTML=""; addLog("ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ."); }
        
        function showMessage(title,msg){
            document.getElementById("modalTitle").textContent=title;
            document.getElementById("modalMsg").textContent=msg;
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modal").classList.add("flex");
        }
        function closeModal(){
            document.getElementById("modal").classList.add("hidden");
            document.getElementById("modal").classList.remove("flex");
        }

        async function fetchDB(){
            const sheetName = sheetSelect.value;
            // v6.0 ì „ìš© ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID ìœ ì§€
            const SPREADSHEET_ID = "1F3HTL6rSOe1Xz30Z5YjS5eJhYvaqlHciMcxeLkQ7o2M";
            const DB_URL = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${encodeURIComponent(sheetName)}`;
            
            matchBtn.disabled = true;
            dbStatus.textContent = "ë°ì´í„° ë¡œë”© ì¤‘...";
            
            try{
                const res = await fetch(DB_URL);
                if(!res.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜");
                const data = await res.json();
                
                dbRows = data.map(r => {
                    const keys = Object.keys(r);
                    return {
                        A: r["í’ˆëª…"] || r[keys[0]] || "",
                        B: r["ê·œê²©"] || r[keys[1]] || "",
                        C: r["ë‹¨ìœ„"] || r[keys[2]] || "",
                        D: String(r["ì¬ë£Œë¹„"] || r[keys[3]] || "0").replace(/,/g,""),
                        E: String(r["ë…¸ë¬´ë¹„"] || r[keys[4]] || "0").replace(/,/g,""),
                        F: r["ë¹„ê³ "] || r[keys[5]] || "" 
                    };
                });
                
                dbStatus.innerHTML = `âœ“ DB ì¤€ë¹„ë¨ (${dbRows.length}ê±´)`;
                dbStatus.className = "mt-2 text-sm text-emerald-600 font-semibold";
                addLog(`DB ë¡œë“œ ì„±ê³µ: ${sheetName} (${dbRows.length}í–‰)`, 'success');
                if(csvRows.length > 0) matchBtn.disabled=false;
            } catch(err){
                dbStatus.textContent = "DB ë¡œë“œ ì‹¤íŒ¨";
                dbStatus.className = "mt-2 text-sm text-red-600 font-semibold";
                addLog("DB ë¡œë“œ ì˜¤ë¥˜: "+err.message,'error');
            }
        }

        sheetSelect.addEventListener("change", fetchDB);

        document.getElementById("excelFile").addEventListener("change", e=>{
            const file = e.target.files[0];
            if(!file) return;
            uploadedFileName = file.name.split('.').slice(0, -1).join('.');
            addLog(`íŒŒì¼ ì—…ë¡œë“œ ë¶„ì„: ${file.name}`);
            const reader = new FileReader();
            reader.onload = (evt)=>{
                try{
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, {type:'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvRows = XLSX.utils.sheet_to_json(worksheet, {header:1});
                    addLog(`ì—‘ì…€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${csvRows.length}í–‰)`, 'success');
                    if(dbRows.length > 0) matchBtn.disabled=false;
                } catch(err){ 
                    addLog("íŒŒì¼ ì˜¤ë¥˜: "+err.message, 'error'); 
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function startWorkerMatch(){
            if(csvRows.length < 2) return showMessage("ì˜¤ë¥˜","ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            if(dbRows.length === 0) return showMessage("ì˜¤ë¥˜","DBê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            addLog("ì •ë°€ ì—”ì§„ ê°€ë™...");
            matchBtn.disabled = true;
            downloadBtn.disabled = true;
            const contentRows = csvRows.slice(1);
            worker.postMessage({ type:'START', csvRows: contentRows, dbRows: dbRows });
        }

        async function downloadExcel(){
            if(!resultRows || resultRows.length === 0) return;
            try {
                addLog("ê²°ê³¼ íŒŒì¼ ìƒì„± ì¤‘ (ExcelJS ìŠ¤íƒ€ì¼ë§ ì ìš©)...");
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('ë§¤ì¹­ê²°ê³¼');
                const header = ["í’ˆëª…", "ê·œê²©", "ë‹¨ìœ„", "ì¬ë£Œë¹„", "ë…¸ë¬´ë¹„", "ë¹„ê³ ", "ìˆœìœ„"];
                const headerRow = worksheet.addRow(header);
                
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4F46E5' } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                });

                resultRows.forEach(data => {
                    const row = worksheet.addRow(data);
                    const rank = data[6] || "";
                    if (rank.includes('í›„ë³´')) {
                        row.eachCell((cell) => { cell.font = { color: { argb: 'FFFF0000' } }; });
                        if (rank.includes('ì¶©ëŒ')) {
                            row.eachCell((cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } }; });
                        }
                    } else if (rank === 'ì›ë³¸') {
                        row.eachCell((cell) => {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                        });
                    }
                });

                worksheet.columns = [
                    { width: 32 }, { width: 22 }, { width: 10 }, 
                    { width: 15 }, { width: 15 }, { width: 40 }, { width: 20 }
                ];

                const today = new Date();
                const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '.');
                const finalFileName = `${uploadedFileName}_ë§¤ì¹­ê²°ê³¼_${dateStr}.xlsx`;
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = finalFileName; a.click();
                window.URL.revokeObjectURL(url);
                addLog(`íŒŒì¼ ì €ì¥ ì™„ë£Œ: ${finalFileName}`, 'success');
            } catch (err) { addLog("ì €ì¥ ì˜¤ë¥˜: " + err.message, 'error'); }
        }

        initWorker();
        window.onload = fetchDB;
    </script>
</body>
</html>
