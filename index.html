<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> üåè AI Îß§Ïπ≠ ÏãúÏä§ÌÖú( UI6.0 beta )</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Ïä§ÌÉÄÏùº ÏßÄÏõêÏùÑ ÏúÑÌïú ExcelJS Ï∂îÍ∞Ä -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .btn-text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Í≤¨Ï†ÅÎèÑÏö∞ÎØ∏ v6.0 (Î¨¥Î£åÎ≤ÑÏ†º) </h1>
            <p class="text-slate-600 font-medium text-indigo-600">S A M J I N </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 1. ÏÑ§Ï†ï Î∞è ÏóÖÎ°úÎìú -->
            <div class="md:col-span-1 space-y-6">

                <!-- ÏãúÌä∏ ÏÑ†ÌÉù (10Í∞úÎ°ú ÌôïÏû•Îê®) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">DB ÏãúÌä∏ ÏÑ†ÌÉù</h2>
                    <select id="sheetSelect" class="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="Sheet10">Sheet</option>
                        <option value="DB1">DB1</option>
                        <option value="DB2">DB2</option>
                        <option value="DB3">DB3</option>
                        <option value="Sheet4">Sheet4</option>
                        <option value="Sheet5">Sheet5</option>
                        <option value="Sheet6">Sheet6</option>
                        <option value="Sheet7">Sheet7</option>
                        <option value="Sheet8">Sheet8</option>
                        <option value="Sheet9">Sheet9</option>
                        <option value="Sheet10">Sheet10</option>
                        
                    </select>
                    <div id="dbStatus" class="mt-2 text-sm text-amber-600">DB ÏÉÅÌÉú: Î°úÎìú Ï†Ñ</div>
                </div>

                <!-- ÌååÏùº ÏóÖÎ°úÎìú -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">ÌååÏùº ÏóÖÎ°úÎìú</h2>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all cursor-pointer border border-slate-200 rounded-lg p-1">
                </div>

                <!-- Ïã§Ìñâ Î≤ÑÌäº -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">Ïã§Ìñâ Î∞è Ï†ÄÏû•</h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="startWorkerMatch()" id="matchBtn" disabled
                            class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 disabled:bg-slate-300 disabled:shadow-none transition-all relative overflow-hidden btn-text-shadow border border-indigo-600">
                            ‚ö°Îß§Ïπ≠ Ïã§Ìñâ
                        </button>
                        <button onclick="downloadExcel()" id="downloadBtn" disabled
                            class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 disabled:opacity-50 transition-all">
                            ÏóëÏÖÄ Í≤∞Í≥º Ï†ÄÏû•
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Î°úÍ∑∏ -->
            <div class="md:col-span-2 space-y-4">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-xl flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-slate-200 font-semibold">ÏãúÏä§ÌÖú Î°úÍ∑∏</h2>
                        <button onclick="clearLog()" class="text-xs text-slate-400 hover:text-white uppercase tracking-wider">Clear</button>
                    </div>
                    <div id="log" class="log-container flex-1 text-[13px] font-mono text-green-400 overflow-y-auto whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Î™®Îã¨ -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl border border-slate-100">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-slate-800">ÏïåÎ¶º</h3>
            <p id="modalMsg" class="text-slate-600 mb-6 leading-relaxed"></p>
            <button onclick="closeModal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition-colors">ÌôïÏù∏</button>
        </div>
    </div>

    <!-- Worker Script -->
    <script id="worker-script" type="javascript/worker">
        const SYNONYM_MAP = {
            "Îã•Ìä∏": "ÎçïÌä∏", "DUCT": "ÎçïÌä∏", "Î∞∞Í¥Ä": "Í¥Ä", "ÌååÏù¥ÌîÑ": "Í¥Ä", "PIPE": "Í¥Ä","Î≥¥Ïò®Ïû¨": "Î≥¥Ïò®", "Í¥ÄÎ≥¥Ïò®": "Î≥¥Ïò®",
            "Î∞úÌè¨Ìè¥Î¶¨ÏóêÌã∏Î†å": "Î∞úÌè¨", "Í≥†Î¨¥Î∞úÌè¨": "Î∞úÌè¨", "Í∞ÄÍµêÎ∞úÌè¨": "Î∞úÌè¨", "ÎÇúÏó∞": "ÏïÑÌã∞Î°†",
            "ÏùÄÎ∞ï": "Îß§ÏßÅÌÖåÏù¥ÌîÑ", "Îß§ÏßÅ": "Îß§ÏßÅÌÖåÏù¥ÌîÑ","ÌñâÍ±∞": "ÌñâÍ∞Ä", "Îã¨ÎåÄ": "Ï†ÑÏÇ∞", "ÌÖåÌîÑ": "ÌÖåÏù¥ÌîÑ","PUMP": "ÌéåÌîÑ", "TANK": "ÌÉ±ÌÅ¨", "GATE": "Í≤åÏù¥Ìä∏", "S#": "SCH",
            "PIPE":"Í¥Ä","ÌååÏù¥ÌîÑ":"Í¥Ä","SPP":"Í∞ïÍ¥Ä","CARBON STEEL":"Í∞ïÍ¥Ä","ÌùëÍ¥Ä":"Í∞ïÍ¥Ä","Î∞±Í¥Ä":"Í∞ïÍ¥Ä",
            "SUS":"STS","STAINLESS":"STS","Ïä§ÌÖê":"STS","Ïä§ÌÖåÏù∏Î¶¨Ïä§":"STS","SU":"STS",
            "PVC":"PVC","VG1":"PVC","VG2":"PVC","COPPER":"ÎèôÍ¥Ä","ÎèôÌååÏù¥ÌîÑ":"ÎèôÍ¥Ä",
            "PB":"PB","ÏóêÏù¥ÏΩò":"PB","Ìè¥Î¶¨Î∂ÄÌã∏Î†å":"PB","C-PVC":"CPVC","ÏÜåÎ∞©Ïö©Ìï©ÏÑ±ÏàòÏßÄ":"CPVC",
            "PE":"PE","P.E":"PE","HDPE":"PE","SR":"SR","S.R":"SR",
            "FITTING":"Ïù¥ÏùåÏá†","Î∂ÄÏÜç":"Ïù¥ÏùåÏá†","ELBOW":"ÏóòÎ≥¥","ELL":"ÏóòÎ≥¥",
            "TEE":"Ìã∞","Ìã∞Ïù¥":"Ìã∞","REDUCER":"Î†àÎìÄÏÉ§","RED":"Î†àÎìÄÏÉ§","Ïù¥Í≤ΩÏÜåÏºì":"Î†àÎìÄÏÉ§",
            "SOCKET":"ÏÜåÏºì","SOC":"ÏÜåÏºì","COUPLING":"Ïª§ÌîåÎßÅ",
            "Ï∫°":"Ï∫°","CAP":"Ï∫°","ÎßàÍ∞ú":"Ï∫°","FLANGE":"ÌîåÎûúÏßÄ",
            "UNION":"Ïú†ÎãàÏò®","UN":"Ïú†ÎãàÏò®","NIPPLE":"ÎãàÌîå",
            "BUSHING":"Î∂ÄÏã±","BUSH":"Î∂ÄÏã±","ADAPTER":"ÏïÑÎãµÌÉÄ","M.A":"ÏïÑÎãµÌÉÄ","F.A":"ÏïÑÎãµÌÉÄ","ADPT":"ÏïÑÎãµÌÉÄ",
            "CROSS":"ÌÅ¨Î°úÏä§","SADDLE":"ÏÉàÎì§","PLUG":"ÌîåÎü¨Í∑∏","Î©îÍæ∏Îùº":"ÌîåÎü¨Í∑∏",
            "VALVE":"Î∞∏Î∏å","V/V":"Î∞∏Î∏å","V.V":"Î∞∏Î∏å","GATE":"Í≤åÏù¥Ìä∏","Ï†úÏàòÎ≥Ä":"Í≤åÏù¥Ìä∏",
            "GLOBE":"Í∏ÄÎ°úÎ∏å","Ïä§ÌÜ±Î∞∏Î∏å":"Í∏ÄÎ°úÎ∏å","CHECK":"Ï≤¥ÌÅ¨","ÌåêÏ≤¥ÌÅ¨":"Ï≤¥ÌÅ¨","Ïä§ÏúôÏ≤¥ÌÅ¨":"Ï≤¥ÌÅ¨",
            "HAMMERLESS":"Ï≤¥ÌÅ¨","BALL":"Î≥º","Î≥ºÎ∞∏Î∏å":"Î≥º","BUTTERFLY":"Î≤ÑÌÑ∞ÌîåÎùºÏù¥","B.F":"Î≤ÑÌÑ∞ÌîåÎùºÏù¥",
            "BFV":"Î≤ÑÌÑ∞ÌîåÎùºÏù¥","STRAINER":"Ïä§Ìä∏Î†àÏù¥ÎÑà","STR":"Ïä§Ìä∏Î†àÏù¥ÎÑà","Y-STR":"Ïä§Ìä∏Î†àÏù¥ÎÑà",
            "PRV":"Í∞êÏïïÎ≥Ä","REDUCING":"Í∞êÏïïÎ≥Ä","SOL":"ÏÜîÎ†àÎÖ∏Ïù¥Îìú","SOLENOID":"ÏÜîÎ†àÎÖ∏Ïù¥Îìú",
            "AIR VENT":"ÏóêÏñ¥Î≤§Ìä∏","A.V":"ÏóêÏñ¥Î≤§Ìä∏","ÌÜµÍ∏∞":"ÏóêÏñ¥Î≤§Ìä∏","SAFETY":"ÏïàÏ†ÑÎ≥Ä","RELIEF":"Î¶¥Î¶¨ÌîÑ",
            "FLOAT":"Ï†ïÏàòÏúÑ","F.V":"Ï†ïÏàòÏúÑ","HEAD":"Ìó§Îìú","SPRINKLER":"Ìó§Îìú","S.P":"Ìó§Îìú",
            "ALARM":"ÏïåÎûå","Ïú†ÏàòÍ≤ÄÏßÄ":"ÏïåÎûå","HYDRANT":"ÏÜåÌôîÏ†Ñ","O.H":"ÏÜåÌôîÏ†Ñ",
            "SIAMESE":"ÏÜ°ÏàòÍµ¨","BOX":"Î∞ïÏä§","Ìï©":"Î∞ïÏä§","Ìï®":"Î∞ïÏä§","F.BOX":"ÏÜåÌôîÏ†ÑÌï®",
            "INSULATION":"Î≥¥Ïò®","LAGGING":"Î≥¥Ïò®","RUBBER":"Í≥†Î¨¥Î∞úÌè¨","ÏïÑÎßàÌîåÎ†âÏä§":"Í≥†Î¨¥Î∞úÌè¨",
            "GLASS WOOL":"Í∑∏ÎùºÏä§Ïö∏","Ïú†Î¶¨ÏÜú":"Í∑∏ÎùºÏä§Ïö∏","HANGER":"ÌñâÍ∞Ä","CLEVIS":"ÌñâÍ∞Ä","RING":"ÌñâÍ∞Ä",
            "SUPPORT":"ÏÑúÌè¨Ìä∏","ÏßÄÏßÄÎåÄ":"ÏÑúÌè¨Ìä∏","ANGLE":"ÏïµÍ∏Ä","CHANNEL":"Ï∞¨ÎÑ¨","ÏûîÎÑ¨":"Ï∞¨ÎÑ¨",
            "BOLT":"Î≥ºÌä∏","NUT":"ÎÑàÌä∏","GASKET":"Í∞ÄÏä§Ïºì","PACKING":"Í∞ÄÏä§Ïºì","P.K":"Í∞ÄÏä§Ïºì",
        };

        const MATERIAL_MAP = {
            "STS": ["STS","Ïä§ÌÖê","SUS","STAINLESS"],
            "STEEL": ["Í∞ïÍ¥Ä","SPP","Î∞±Í¥Ä","ÌùëÍ¥Ä","CARBON","SPPS"],
            "PVC": ["PVC","VG1","VG2"],
            "COPPER": ["ÎèôÍ¥Ä","ÎèôÌååÏù¥ÌîÑ","COPPER"],
            "PB": ["PB","ÏóêÏù¥ÏΩò"],
            "CPVC": ["CPVC"],
            "PE": ["PE","HDPE"]
        };

        const TYPE_MAP = {
            "ELBOW": ["ÏóòÎ≥¥","ELL","L"],
            "TEE": ["Ìã∞","Ìã∞Ïù¥","T"],
            "VALVE": ["Î∞∏Î∏å","V/V"],
            "PIPE": ["ÌååÏù¥ÌîÑ","Í¥Ä"]
        };

        const synKeys = Object.keys(SYNONYM_MAP).sort((a,b)=>b.length-a.length);
        const synRegex = new RegExp(synKeys.join("|"),"gi");

        function norm(v, isSpec = false){ 
            if(!v) return ""; 
            let str = v.toString().trim().toUpperCase(); 
            str = str.replace(synRegex,(m)=>SYNONYM_MAP[m.toUpperCase()]||m); 
            if (isSpec) {
                return str.replace(/[^A-Z0-9Í∞Ä-Ìû£./]/g,"");
            }
            return str.replace(/[^A-Z0-9Í∞Ä-Ìû£]/g,"").replace(/EA|EACH|Í∞ú/g,"EA"); 
        }

        function getCategory(text, map) {
            for (const [key, keywords] of Object.entries(map)) {
                if (keywords.some(k => text.includes(k))) return key;
            }
            return null;
        }

        function isCategoryMismatch(src, tgt){ 
            const srcMat = getCategory(src, MATERIAL_MAP);
            const tgtMat = getCategory(tgt, MATERIAL_MAP);
            if (srcMat && tgtMat && srcMat !== tgtMat) return true;
            const srcType = getCategory(src, TYPE_MAP);
            const tgtType = getCategory(tgt, TYPE_MAP);
            if (srcType && tgtType && srcType !== tgtType) return true;
            return false; 
        }

        function calculateScore(srcText, tgtText) {
            if(!srcText || !tgtText) return 0;
            if(srcText === tgtText) return 100;
            if(tgtText.includes(srcText) || srcText.includes(tgtText)) return 85;
            let matchCount = 0;
            for(let i=0; i<srcText.length-1; i++) {
                const sub = srcText.substring(i, i+2);
                if(tgtText.includes(sub)) matchCount++;
            }
            return (matchCount / Math.max(srcText.length, tgtText.length)) * 100;
        }

        self.onmessage = function(e) {
            const { type, csvRows, dbRows } = e.data;
            if(type !== 'START') return;

            const finalResult = [];
            const total = csvRows.length;

            const processedDB = dbRows.map(row => ({
                original: row,
                normName: norm(row.A),
                normSpec: norm(row.B, true),
                normUnit: norm(row.C)
            }));

            for(let i=0; i < total; i++) {
                const percent = Math.floor((i / total) * 100);
                if(i % 100 === 0) self.postMessage({ type: 'PROGRESS', percent });

                const row = csvRows[i];
                const srcName = row[0] || "";
                const srcSpec = row[1] || "";
                const srcUnit = row[2] || "";
                const srcMat = row[3] || 0;
                const srcLab = row[4] || 0;

                const nName = norm(srcName);
                const nSpec = norm(srcSpec, true);
                const nUnit = norm(srcUnit);

                if(!nName) {
                    finalResult.push([srcName, srcSpec, srcUnit, srcMat, srcLab, "", ""]);
                    continue;
                }

                let candidates = [];
                for(let j=0; j < processedDB.length; j++) {
                    const dbItem = processedDB[j];
                    const isPerfectMatch = (nName === dbItem.normName && nSpec === dbItem.normSpec);
                    if(!isPerfectMatch && isCategoryMismatch(nName, dbItem.normName)) continue;
                    const nameScore = calculateScore(nName, dbItem.normName);
                    const specScore = calculateScore(nSpec, dbItem.normSpec);
                    const unitScore = (nUnit === dbItem.normUnit) ? 100 : 0;
                    let totalScore = (nameScore * 0.5) + (specScore * 0.4) + (unitScore * 0.1);
                    
                    if(isPerfectMatch) totalScore += 200; 
                    
                    if(totalScore > 15) { 
                        candidates.push({ score: totalScore, item: dbItem.original });
                    }
                }

                candidates.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    let valA = String(a.item.F || "");
                    let valB = String(b.item.F || "");
                    let numA = parseFloat(valA.replace(/[^0-9.-]/g, ''));
                    let numB = parseFloat(valB.replace(/[^0-9.-]/g, ''));
                    if (!isNaN(numA) && !isNaN(numB)) {
                        if (numB !== numA) return numB - numA; 
                    }
                    return valB.localeCompare(valA); 
                });

                const topCandidates = candidates.slice(0, 5); 

                finalResult.push([srcName, srcSpec, srcUnit, srcMat, srcLab, "", "ÏõêÎ≥∏"]);

                if (topCandidates.length === 0) {
                    finalResult.push(["", "", "", "", "", "Îß§Ïπ≠ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå", "Îß§Ïπ≠ÏóÜÏùå"]);
                } else {
                    topCandidates.forEach((cand, idx) => {
                        const db = cand.item;
                        let status = `ÌõÑÎ≥¥ ${idx + 1}`;
                        if (idx === 0 && topCandidates.length > 1) {
                            const gap = topCandidates[0].score - topCandidates[1].score;
                            if (topCandidates[0].score < 200 && (gap < 10 || topCandidates[0].score < 50)) {
                                status += " (Ï∂©Îèå/Í≤ÄÌÜ†ÌïÑÏöî)";
                            }
                        }
                        finalResult.push([db.A || "", db.B || "", db.C || "", db.D || "", db.E || "", db.F || "", status]);
                    });
                }
                finalResult.push(["", "", "", "", "", "", ""]);
            }

            self.postMessage({ type: 'COMPLETE', resultRows: finalResult });
        };
    </script>

    <script>
        let dbRows = [];
        let csvRows = [];
        let worker = null;
        let resultRows = [];
        let uploadedFileName = "Îã®Í∞ÄÎß§Ïπ≠Í≤∞Í≥º"; 

        const logEl = document.getElementById("log");
        const matchBtn = document.getElementById("matchBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const dbStatus = document.getElementById("dbStatus");
        const sheetSelect = document.getElementById("sheetSelect");

        function initWorker() {
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            const workerUrl = URL.createObjectURL(blob);
            worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                const { type, percent, resultRows: res } = e.data;
                if(type === 'PROGRESS') {
                    matchBtn.style.background = `linear-gradient(to right, #059669 ${percent}%, #4f46e5 ${percent}%)`;
                    matchBtn.textContent = `‚ö°Î∂ÑÏÑù Ï§ë... ${percent}%`;
                } else if(type === 'COMPLETE') {
                    resultRows = res;
                    addLog(`Îß§Ïπ≠ ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å! (Ï†ïÎ∞Ä Ï†ïÎ†¨ ÏïåÍ≥†Î¶¨Ï¶ò Ï†ÅÏö©)`, 'success');
                    matchBtn.disabled = false;
                    matchBtn.style.background = '';
                    matchBtn.textContent = '‚ö°Îß§Ïπ≠ Ïã§Ìñâ';
                    downloadBtn.disabled = false;
                    showMessage("Î∂ÑÏÑù ÏôÑÎ£å", `Îç∞Ïù¥ÌÑ∞ Îß§Ïπ≠ Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`);
                }
            };
        }

        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('ko-KR', {hour12:false});
            let prefix = "‚óè";
            if(type==='success') prefix="‚úì";
            if(type==='error') prefix="‚úó";
            const div = document.createElement('div');
            div.textContent = `[${time}] ${prefix} ${msg}`;
            if(type === 'error') div.style.color = '#ef4444';
            if(type === 'success') div.style.color = '#34d399';
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() { logEl.innerHTML=""; addLog("ÏãúÏä§ÌÖú Ï§ÄÎπÑ ÏôÑÎ£å."); }
        
        function showMessage(title,msg){
            document.getElementById("modalTitle").textContent=title;
            document.getElementById("modalMsg").textContent=msg;
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modal").classList.add("flex");
        }
        function closeModal(){
            document.getElementById("modal").classList.add("hidden");
            document.getElementById("modal").classList.remove("flex");
        }

        async function fetchDB(){
            const sheetName = sheetSelect.value;
            // v6.0 Ï†ÑÏö© Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ID Ïú†ÏßÄ
            const SPREADSHEET_ID = "1F3HTL6rSOe1Xz30Z5YjS5eJhYvaqlHciMcxeLkQ7o2M";
            const DB_URL = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${encodeURIComponent(sheetName)}`;
            
            matchBtn.disabled = true;
            dbStatus.textContent = "Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...";
            
            try{
                const res = await fetch(DB_URL);
                if(!res.ok) throw new Error("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏùëÎãµ Ïò§Î•ò");
                const data = await res.json();
                
                dbRows = data.map(r => {
                    const keys = Object.keys(r);
                    return {
                        A: r["ÌíàÎ™Ö"] || r[keys[0]] || "",
                        B: r["Í∑úÍ≤©"] || r[keys[1]] || "",
                        C: r["Îã®ÏúÑ"] || r[keys[2]] || "",
                        D: String(r["Ïû¨Î£åÎπÑ"] || r[keys[3]] || "0").replace(/,/g,""),
                        E: String(r["ÎÖ∏Î¨¥ÎπÑ"] || r[keys[4]] || "0").replace(/,/g,""),
                        F: r["ÎπÑÍ≥†"] || r[keys[5]] || "" 
                    };
                });
                
                dbStatus.innerHTML = `‚úì DB Ï§ÄÎπÑÎê® (${dbRows.length}Í±¥)`;
                dbStatus.className = "mt-2 text-sm text-emerald-600 font-semibold";
                addLog(`DB Î°úÎìú ÏÑ±Í≥µ: ${sheetName} (${dbRows.length}Ìñâ)`, 'success');
                if(csvRows.length > 0) matchBtn.disabled=false;
            } catch(err){
                dbStatus.textContent = "DB Î°úÎìú Ïã§Ìå®";
                dbStatus.className = "mt-2 text-sm text-red-600 font-semibold";
                addLog("DB Î°úÎìú Ïò§Î•ò: "+err.message,'error');
            }
        }

        sheetSelect.addEventListener("change", fetchDB);

        document.getElementById("excelFile").addEventListener("change", e=>{
            const file = e.target.files[0];
            if(!file) return;
            uploadedFileName = file.name.split('.').slice(0, -1).join('.');
            addLog(`ÌååÏùº ÏóÖÎ°úÎìú Î∂ÑÏÑù: ${file.name}`);
            const reader = new FileReader();
            reader.onload = (evt)=>{
                try{
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, {type:'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvRows = XLSX.utils.sheet_to_json(worksheet, {header:1});
                    addLog(`ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å (${csvRows.length}Ìñâ)`, 'success');
                    if(dbRows.length > 0) matchBtn.disabled=false;
                } catch(err){ 
                    addLog("ÌååÏùº Ïò§Î•ò: "+err.message, 'error'); 
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function startWorkerMatch(){
            if(csvRows.length < 2) return showMessage("Ïò§Î•ò","Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
            if(dbRows.length === 0) return showMessage("Ïò§Î•ò","DBÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            addLog("Ï†ïÎ∞Ä ÏóîÏßÑ Í∞ÄÎèô...");
            matchBtn.disabled = true;
            downloadBtn.disabled = true;
            const contentRows = csvRows.slice(1);
            worker.postMessage({ type:'START', csvRows: contentRows, dbRows: dbRows });
        }

        async function downloadExcel(){
            if(!resultRows || resultRows.length === 0) return;
            try {
                addLog("Í≤∞Í≥º ÌååÏùº ÏÉùÏÑ± Ï§ë (ExcelJS Ïä§ÌÉÄÏùºÎßÅ Ï†ÅÏö©)...");
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Îß§Ïπ≠Í≤∞Í≥º');
                const header = ["ÌíàÎ™Ö", "Í∑úÍ≤©", "Îã®ÏúÑ", "Ïû¨Î£åÎπÑ", "ÎÖ∏Î¨¥ÎπÑ", "ÎπÑÍ≥†", "ÏàúÏúÑ"];
                const headerRow = worksheet.addRow(header);
                
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4F46E5' } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                });

                resultRows.forEach(data => {
                    const row = worksheet.addRow(data);
                    const rank = data[6] || "";
                    if (rank.includes('ÌõÑÎ≥¥')) {
                        row.eachCell((cell) => { cell.font = { color: { argb: 'FFFF0000' } }; });
                        if (rank.includes('Ï∂©Îèå')) {
                            row.eachCell((cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } }; });
                        }
                    } else if (rank === 'ÏõêÎ≥∏') {
                        row.eachCell((cell) => {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                        });
                    }
                });

                worksheet.columns = [
                    { width: 32 }, { width: 22 }, { width: 10 }, 
                    { width: 15 }, { width: 15 }, { width: 40 }, { width: 20 }
                ];

                const today = new Date();
                const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '.');
                const finalFileName = `${uploadedFileName}_Îß§Ïπ≠Í≤∞Í≥º_${dateStr}.xlsx`;
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = finalFileName; a.click();
                window.URL.revokeObjectURL(url);
                addLog(`ÌååÏùº Ï†ÄÏû• ÏôÑÎ£å: ${finalFileName}`, 'success');
            } catch (err) { addLog("Ï†ÄÏû• Ïò§Î•ò: " + err.message, 'error'); }
        }

        initWorker();
        window.onload = fetchDB;
    </script>
</body>
</html>


