import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area 
} from 'recharts';
import { 
  RefreshCw, TrendingUp, TrendingDown, ArrowRightLeft, 
  Globe, Clock, AlertCircle, Sparkles, Database 
} from 'lucide-react';

// API 설정
const API_BASE = "https://api.frankfurter.app";

export default function App() {
  const [baseCurrency, setBaseCurrency] = useState('USD');
  const [targetCurrency, setTargetCurrency] = useState('KRW');
  const [rates, setRates] = useState({});
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isDemoData, setIsDemoData] = useState(false); // 데모 데이터 사용 여부
  const [amount, setAmount] = useState(1);
  const [aiAnalysis, setAiAnalysis] = useState("");
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  // 주요 통화 목록
  const majorCurrencies = ['USD', 'EUR', 'JPY', 'GBP', 'CNY', 'AUD', 'CAD', 'CHF'];

  // 데모 데이터 생성 함수 (API 실패 시 사용)
  const generateMockData = (base, target) => {
    // 기준 환율 대략 설정 (KRW 기준)
    const baseRates = {
      'USD': 1, 'EUR': 0.92, 'JPY': 150.5, 'GBP': 0.79, 
      'CNY': 7.2, 'KRW': 1380, 'AUD': 1.52, 'CAD': 1.36, 'CHF': 0.91
    };
    
    // 타겟 통화에 대한 상대적 가치 계산
    const baseRate = baseRates[base] || 1;
    const targetRate = baseRates[target] || 1;
    // USD 기준 변환: (1 / base) * target
    const crossRate = (1 / baseRates[base]) * baseRates[target];
    
    // 현재 환율 모의 데이터
    const mockRates = {};
    majorCurrencies.forEach(curr => {
        if (curr === base) return;
        const currRate = baseRates[curr];
        mockRates[curr] = (1 / baseRates[base]) * currRate;
    });
    // KRW 등 추가
    if (base !== 'KRW') mockRates['KRW'] = (1 / baseRates[base]) * baseRates['KRW'];

    // 히스토리 모의 데이터 (랜덤 워크)
    const mockHistory = [];
    let currentRate = crossRate;
    const today = new Date();
    
    for (let i = 30; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      
      // -1% ~ +1% 변동
      const change = 1 + (Math.random() * 0.02 - 0.01);
      currentRate *= change;
      
      mockHistory.push({
        date: d.toISOString().slice(5, 10), // MM-DD
        rate: currentRate
      });
    }

    return { rates: mockRates, history: mockHistory };
  };

  // 데이터 페칭 함수
  const fetchData = async () => {
    setLoading(true);
    setError(null);
    setIsDemoData(false);

    try {
      // 1. 최신 환율 가져오기
      const latestRes = await fetch(`${API_BASE}/latest?from=${baseCurrency}`);
      if (!latestRes.ok) throw new Error("API Connection Failed");
      const latestData = await latestRes.json();
      setRates(latestData.rates);

      // 2. 최근 30일간의 히스토리 가져오기
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      const historyRes = await fetch(`${API_BASE}/${startDate}..${endDate}?from=${baseCurrency}&to=${targetCurrency}`);
      if (!historyRes.ok) throw new Error("History API Failed");
      const historyData = await historyRes.json();
      
      const chartData = Object.entries(historyData.rates).map(([date, val]) => ({
        date: date.slice(5),
        rate: val[targetCurrency]
      }));
      setHistory(chartData);
      
    } catch (err) {
      console.warn("API 호출 실패, 데모 데이터로 전환합니다.", err);
      // API 실패 시 데모 데이터 사용
      const { rates: mockRates, history: mockHistory } = generateMockData(baseCurrency, targetCurrency);
      setRates(mockRates);
      setHistory(mockHistory);
      setIsDemoData(true);
      setError("실시간 서버 연결이 원활하지 않아 '데모 모드'로 실행됩니다.");
    } finally {
      setLoading(false);
    }
  };

  // 초기 로딩 및 통화 변경 시 데이터 갱신
  useEffect(() => {
    fetchData();
  }, [baseCurrency, targetCurrency]);

  // Gemini AI 분석 실행
  const analyzeTrend = async () => {
    if (!history.length || isAnalyzing) return;
    
    setIsAnalyzing(true);
    const lastRate = history[history.length - 1].rate;
    const firstRate = history[0].rate;
    const change = (((lastRate - firstRate) / firstRate) * 100).toFixed(2);
    
    const prompt = `최근 30일간 ${baseCurrency}/${targetCurrency} 환율이 ${firstRate.toFixed(2)}에서 ${lastRate.toFixed(2)}로 약 ${change}% 변동했습니다. 이 추세에 대한 짧은 경제적 통찰(2-3문장)을 한국어로 작성해줘.`;
    const apiKey = ""; // API 키는 런타임 환경에서 주입됩니다.

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });
      const result = await response.json();
      setAiAnalysis(result.candidates?.[0]?.content?.parts?.[0]?.text || "분석 결과를 가져올 수 없습니다.");
    } catch (err) {
      setAiAnalysis("AI 분석 중 오류가 발생했습니다.");
    } finally {
      setIsAnalyzing(false);
    }
  };

  // 계산된 환율 값 메모이제이션
  const convertedAmount = useMemo(() => {
    if (!rates[targetCurrency] && !isDemoData) return 0;
    // 데모 모드일 때 rates에 값이 없을 수 있으므로 방어 코드
    const rate = rates[targetCurrency] || (history.length > 0 ? history[history.length-1].rate : 0);
    return (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2 });
  }, [amount, rates, targetCurrency, history, isDemoData]);

  const changePercent = history.length > 0 
    ? (((history[history.length-1].rate - history[0].rate)/history[0].rate)*100).toFixed(2) 
    : 0;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        
        {/* Header */}
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Globe className="text-blue-600 w-8 h-8" />
              글로벌 환율 실시간 대시보드
            </h1>
            <p className="text-slate-500 text-sm mt-1 flex items-center gap-1">
              <Clock className="w-4 h-4" />
              마지막 업데이트: {new Date().toLocaleString('ko-KR')}
            </p>
          </div>
          <div className="flex gap-2">
            {isDemoData && (
              <div className="flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-800 rounded-lg text-xs font-bold uppercase tracking-wider">
                <Database className="w-3 h-3" />
                Demo Mode
              </div>
            )}
            <button 
              onClick={fetchData}
              className="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl transition-all font-medium text-sm"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              새로고침
            </button>
          </div>
        </header>

        {/* Top Cards & Converter */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          {/* Quick Converter Card */}
          <div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <ArrowRightLeft className="w-5 h-5 text-blue-500" />
              환율 계산기
            </h2>
            <div className="space-y-4">
              <div>
                <label className="text-xs font-medium text-slate-400 uppercase tracking-wider">기준 통화</label>
                <div className="flex gap-2 mt-1">
                  <input 
                    type="number" 
                    value={amount} 
                    onChange={(e) => setAmount(Math.max(0, parseFloat(e.target.value) || 0))}
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium"
                  />
                  <select 
                    value={baseCurrency} 
                    onChange={(e) => setBaseCurrency(e.target.value)}
                    className="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold cursor-pointer"
                  >
                    {majorCurrencies.map(c => <option key={c} value={c}>{c}</option>)}
                    <option value="KRW">KRW</option>
                  </select>
                </div>
              </div>

              <div className="flex justify-center py-2">
                <div className="bg-blue-50 p-2 rounded-full">
                  <ArrowRightLeft className="w-5 h-5 text-blue-600 rotate-90 lg:rotate-0" />
                </div>
              </div>

              <div>
                <label className="text-xs font-medium text-slate-400 uppercase tracking-wider">대상 통화</label>
                <div className="flex gap-2 mt-1">
                  <div className="w-full p-3 bg-blue
